# Generated by Django 4.0.4 on 2023-09-12 12:27

from django.db import migrations, models
import django.db.models.deletion
from django.conf import settings


def reset_dataset_owner(apps, schema_editor):
    # Set owner id to Public Administrator Organisation id before AlterField
    # to avoid ForeignKey constraint conflicts.
    Dataset = apps.get_model("abd_database", "Dataset")
    Organisation = apps.get_model("abd_management", "Organisation")

    pub_admin = Organisation.objects.get(name=settings.PUBLIC_DATA_ADMIN_ORG_NAME)

    for ds in Dataset.objects.all():
        ds.owner.id = pub_admin.id
        ds.save()


class Migration(migrations.Migration):
    dependencies = [
        ('abd_management', '0005_auto_20230912_1431'),
        ('abd_database', '0011_alter_battery_battery_type'),
    ]

    operations = [
        migrations.RunPython(reset_dataset_owner),
        migrations.AlterField(
            model_name='dataset',
            name='owner',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='abd_management.organisation'),
        ),
    ]
